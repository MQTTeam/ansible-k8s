# k8s-manifests/ingress/ingress-rules.yml (신규 생성)

apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: mqtteam-ingress
  namespace: default
  annotations:
    # (필수) Nginx Ingress Controller를 사용하고 웹소켓을 지원하기 위한 설정
    kubernetes.io/ingress.class: "nginx"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "3600"
    nginx.ingress.kubernetes.io/proxy-body-size: "10m"
spec:
  ingressClassName: nginx
  rules:
  # chat.your-domain.com 과 같은 실제 도메인이 있다면 여기에 입력합니다.
  # 없다면 Ingress Controller의 기본 IP로 접속하게 됩니다.
  - host: myapp.local
    http:
      paths:
      # 경로 1: API 서버 (백엔드)
      # /api/ 로 시작하는 모든 요청은 backend-service의 3000번 포트로 전달
      - path: /api
        pathType: Prefix
        backend:
          service:
            name: backend-service
            port:
              number: 3000

      # 경로 2: MQTT 웹소켓 (EMQX)
      # /mqtt 로 시작하는 모든 요청은 emqx-service의 8083번 포트로 전달
      - path: /mqtt(/|$)(.*)
        pathType: Prefix
        backend:
          service:
            name: emqx-service
            port:
              # emqx-service.yml에 정의된 웹소켓(ws) 포트 이름 또는 번호
              number: 1883

      # 경로 3: 웹사이트 (프론트엔드)
      # 위의 경로에 해당하지 않는 모든 요청은 nginx-service의 80번 포트로 전달
      - path: /
        pathType: Prefix
        backend:
          service:
            name: nginx-service
            port:
              number: 80
